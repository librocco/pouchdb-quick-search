"use strict";var mapReduce=require("pouchdb-mapreduce-no-ddocs");Object.keys(mapReduce).forEach(function(e){exports[e]=mapReduce[e]});var utils=require("./pouch-utils"),lunr=require("lunr"),uniq=require("uniq"),Promise=utils.Promise,stringify=require("json-stable-stringify"),indexes={},TYPE_TOKEN_COUNT="a",TYPE_DOC_INFO="b";function add(e,r){return e+r}function getTokenStream(e,r){return r.pipeline.run(lunr.tokenizer(e))}function getText(e,r){var n;if(e.deepField){n=r;for(var t=0,i=e.deepField.length;t<i;t++)n=Array.isArray(n)?n.map(handleNestedObjectArrayItem(e,e.deepField.slice(t))):n&&n[e.deepField[t]]}else n=r[e.field];return n&&(Array.isArray(n)?n=n.join(" "):"string"!=typeof n&&(n=n.toString())),n}function handleNestedObjectArrayItem(e,r){return function(n){return getText(utils.extend({},e,{deepField:r}),n)}}function createMapFunction(e,r,n,t){return function(i,u){if(!isFiltered(i,n,t)){for(var o=[],a=0,c=e.length;a<c;a++){var l,s=getText(e[a],i);if(s){for(var f=getTokenStream(s,r),h=0,d=f.length;h<d;h++){var g=f[h],p=e.length>1?a:void 0;u(TYPE_TOKEN_COUNT+g,p)}l=Math.sqrt(f.length)}else l=0;o.push(l)}u(TYPE_DOC_INFO+i._id,o)}}}function calculateDocumentScores(e,r,n,t,i){var u=Object.keys(n).map(function(u){var o=n[u],a=t[u],c=0;return e.map(function(e){return o.map(function(n,t){var u=a[t];if(!(e in n))return 0;var o=r[e];return n[e]/o*(1/o)*i[t].boost/u}).reduce(add,0)}).forEach(function(e){e>c&&(c=e)}),{id:u,score:c}});return u.sort(function(e,r){return e.score<r.score?1:e.score>r.score?-1:0}),u}function applyIncludeDocs(e,r){return Promise.all(r.map(function(r){return e.get(r.id)})).then(function(e){e.forEach(function(e,n){r[n].doc=e})}).then(function(){return r})}function applyHighlighting(e,r,n,t,i){var u=r.highlighting_pre||"<strong>",o=r.highlighting_post||"</strong>";return Promise.all(n.map(function(r){return Promise.resolve().then(function(){return r.doc?r.doc:e.get(r.id)}).then(function(e){r.highlighting={},i[r.id].forEach(function(n,i){var a=t[i],c=a.field,l=getText(a,e);Object.keys(n).forEach(function(e){var n=new RegExp("("+e+"[a-z]*)","gi"),t=u+"$1"+o;l=l.replace(n,t),r.highlighting[c]=l})})})})).then(function(){return n})}function isFiltered(e,r,n){try{return!(!r||r(e))}catch(e){return n.emit("error",e),!0}}exports.search=utils.toPromise(function(e,r){var n=this,t=(e=utils.extend(!0,{},e)).query||e.q,i="mm"in e?parseFloat(e.mm)/100:1,u=e.fields,o=e.highlighting,a=e.include_docs,c=e.destroy,l=e.stale,s=e.limit,f=e.build,h=e.skip||0,d=e.language||"en",g=e.filter;if(Array.isArray(u)){var p={};u.forEach(function(e){p[e]=1}),u=p}var y=Object.keys(u).map(function(e){return{field:e,deepField:-1!==e.indexOf(".")&&e.split("."),boost:u[e]}}),m=indexes[d];m||(m=indexes[d]=lunr(),Array.isArray(d)?m.use(global.lunr.multiLanguage.apply(this,d)):"en"!==d&&m.use(global.lunr[d]));var v={language:d,fields:y.map(function(e){return e.field}).sort()};g&&(v.filter=g.toString());var _="search-"+utils.MD5(stringify(v)),O=createMapFunction(y,m,g,n),b={saveAs:_};if(c)return b.destroy=!0,n._search_query(O,b,r);if(f)return delete b.stale,b.limit=0,void n._search_query(O,b).then(function(){r(null,{ok:!0})}).catch(r);var E=uniq(getTokenStream(t,m));if(!E.length)return r(null,{total_rows:0,rows:[]});b.keys=E.map(function(e){return TYPE_TOKEN_COUNT+e}),"string"==typeof l&&(b.stale=l),n._search_query(O,b).then(function(t){if(!t.rows.length)return r(null,{total_rows:0,rows:[]});var u=0,c={},f={};if(t.rows.forEach(function(e){var r=e.key.substring(1),n=e.value||0;if(r in f?f[r]++:f[r]=1,!(e.id in c))for(var t=c[e.id]=[],i=0;i<y.length;i++)t[i]={};var u=c[e.id][n];r in u?u[r]++:u[r]=1}),E.length>1&&Object.keys(c).forEach(function(e){var r={},n=c[e];Object.keys(n).forEach(function(e){Object.keys(n[e]).forEach(function(e){r[e]=!0})});var t=Object.keys(r).length/E.length;Math.floor(100*t)/100<i&&delete c[e]}),!Object.keys(c).length)return r(null,{total_rows:0,rows:[]});var d=Object.keys(c).map(function(e){return TYPE_DOC_INFO+e}),g={saveAs:_,keys:d,stale:l};return n._search_query(O,g).then(function(e){var r={};return e.rows.forEach(function(e){r[e.id]=e.value}),calculateDocumentScores(E,f,c,r,y)}).then(function(e){return u=e.length,"number"==typeof s&&s>=0?e.slice(h,h+s):h>0?e.slice(h):e}).then(function(e){return a?applyIncludeDocs(n,e):e}).then(function(r){return o?applyHighlighting(n,e,r,y,c):r}).then(function(e){r(null,{total_rows:u,rows:e})})}).catch(r)}),"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(exports);