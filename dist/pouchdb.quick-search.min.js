"use strict";import mapReduce from"pouchdb-mapreduce-no-ddocs";Object.keys(mapReduce).forEach(function(e){exports[e]=mapReduce[e]});import utils from"./pouch-utils";import lunr from"lunr";import uniq from"uniq";var PouchPromise=utils.PouchPromise;import stringify from"json-stable-stringify";var indexes={},TYPE_TOKEN_COUNT="a",TYPE_DOC_INFO="b";function add(e,t){return e+t}function getTokenStream(e,t){return t.pipeline.run(lunr.tokenizer(e))}function getText(e,t){var r;if(e.deepField){r=t;for(var n=0,i=e.deepField.length;n<i;n++)r=Array.isArray(r)?r.map(handleNestedObjectArrayItem(e,e.deepField.slice(n))):r&&r[e.deepField[n]]}else r=t[e.field];return r&&(Array.isArray(r)?r=r.join(" "):"string"!=typeof r&&(r=r.toString())),r}function handleNestedObjectArrayItem(e,t){return function(r){return getText(utils.extend({},e,{deepField:t}),r)}}function createMapFunction(e,t,r,n){return function(i,o){if(!isFiltered(i,r,n)){for(var u=[],c=0,a=e.length;c<a;c++){var l,s=getText(e[c],i);if(s){for(var f=getTokenStream(s,t),h=0,d=f.length;h<d;h++){var g=f[h],p=e.length>1?c:void 0;o(TYPE_TOKEN_COUNT+g,p)}l=Math.sqrt(f.length)}else l=0;u.push(l)}o(TYPE_DOC_INFO+i._id,u)}}}function calculateDocumentScores(e,t,r,n,i){var o=Object.keys(r).map(function(o){var u=r[o],c=n[o],a=0;return e.map(function(e){return u.map(function(r,n){var o=c[n];if(!(e in r))return 0;var u=t[e];return r[e]/u*(1/u)*i[n].boost/o}).reduce(add,0)}).forEach(function(e){e>a&&(a=e)}),{id:o,score:a}});return o.sort(function(e,t){return e.score<t.score?1:e.score>t.score?-1:0}),o}function applyIncludeDocs(e,t){return PouchPromise.all(t.map(function(t){return e.get(t.id)})).then(function(e){e.forEach(function(e,r){t[r].doc=e})}).then(function(){return t})}function applyHighlighting(e,t,r,n,i){var o=t.highlighting_pre||"<strong>",u=t.highlighting_post||"</strong>";return PouchPromise.all(r.map(function(t){return PouchPromise.resolve().then(function(){return t.doc?t.doc:e.get(t.id)}).then(function(e){t.highlighting={},i[t.id].forEach(function(r,i){var c=n[i],a=c.field,l=getText(c,e);Object.keys(r).forEach(function(e){var r=new RegExp("("+e+"[a-z]*)","gi"),n=o+"$1"+u;l=l.replace(r,n),t.highlighting[a]=l})})})})).then(function(){return r})}function isFiltered(e,t,r){try{return!(!t||t(e))}catch(e){return r.emit("error",e),!0}}exports.search=utils.toPromise(function(e,t){var r=this,n=(e=utils.extend(!0,{},e)).query||e.q,i="mm"in e?parseFloat(e.mm)/100:1,o=e.fields,u=e.highlighting,c=e.include_docs,a=e.destroy,l=e.stale,s=e.limit,f=e.build,h=e.skip||0,d=e.language||"en",g=e.filter;if(Array.isArray(o)){var p={};o.forEach(function(e){p[e]=1}),o=p}var m=Object.keys(o).map(function(e){return{field:e,deepField:-1!==e.indexOf(".")&&e.split("."),boost:o[e]}}),y=indexes[d];y||(y=indexes[d]=lunr(),Array.isArray(d)?y.use(global.lunr.multiLanguage.apply(this,d)):"en"!==d&&y.use(global.lunr[d]));var v={language:d,fields:m.map(function(e){return e.field}).sort()};g&&(v.filter=g.toString());var _="search-"+utils.MD5(stringify(v)),O=createMapFunction(m,y,g,r),b={saveAs:_};if(a)return b.destroy=!0,r._search_query(O,b,t);if(f)return delete b.stale,b.limit=0,void r._search_query(O,b).then(function(){t(null,{ok:!0})}).catch(t);var E=uniq(getTokenStream(n,y));if(!E.length)return t(null,{total_rows:0,rows:[]});b.keys=E.map(function(e){return TYPE_TOKEN_COUNT+e}),"string"==typeof l&&(b.stale=l),r._search_query(O,b).then(function(n){if(!n.rows.length)return t(null,{total_rows:0,rows:[]});var o=0,a={},f={};if(n.rows.forEach(function(e){var t=e.key.substring(1),r=e.value||0;if(t in f?f[t]++:f[t]=1,!(e.id in a))for(var n=a[e.id]=[],i=0;i<m.length;i++)n[i]={};var o=a[e.id][r];t in o?o[t]++:o[t]=1}),E.length>1&&Object.keys(a).forEach(function(e){var t={},r=a[e];Object.keys(r).forEach(function(e){Object.keys(r[e]).forEach(function(e){t[e]=!0})});var n=Object.keys(t).length/E.length;Math.floor(100*n)/100<i&&delete a[e]}),!Object.keys(a).length)return t(null,{total_rows:0,rows:[]});var d=Object.keys(a).map(function(e){return TYPE_DOC_INFO+e}),g={saveAs:_,keys:d,stale:l};return r._search_query(O,g).then(function(e){var t={};return e.rows.forEach(function(e){t[e.id]=e.value}),calculateDocumentScores(E,f,a,t,m)}).then(function(e){return o=e.length,"number"==typeof s&&s>=0?e.slice(h,h+s):h>0?e.slice(h):e}).then(function(e){return c?applyIncludeDocs(r,e):e}).then(function(t){return u?applyHighlighting(r,e,t,m,a):t}).then(function(e){t(null,{total_rows:o,rows:e})})}).catch(t)}),"undefined"!=typeof window&&window.PouchDB&&window.PouchDB.plugin(exports);